extends Resource
class_name TilesetLib

### Stores references to tilesets as well bits conversions to atlas coords[br]
## 1) checks for primary bit match[br]
## 2) checks for secondary bit match[br]
## 3) uses bit match to find and return atlas coord list[br][br]
## should default to secondary bit 0 if nothing is found[br][br]
## bits are calculated, with squares, with: 1,2,4,8,16,32,64,128 values going clockwise starting from the top-left corner[br]
## the center is skipped[br]
## secondary (fall-back) bits only use the 4 sides of the tile, 1,2,4,8 values going clockwise from the top side

## it is recommended to just use the same positions as debug, but remove the ones you don't use

#NOTE: these are good for reference, I just needed it for debugging
#8 point bit to id
const debug_primary_bits_to_id : Dictionary[int,int] = {
	0 : 0,
	1 : 1,
	2 : 5,
	3 : 12,
	4 : 2,
	5 : 32,
	6 : 11,
	8 : 6,
	9 : 25,
	10 : 18,
	12 : 14,
	13 : 71,
	14 : 74,
	15 : 95,
	16 : 3,
	17 : 30,
	18 : 27,
	19 : 49,
	20 : 33,
	21 : 78,
	22 : 67,
	23 : 104,
	24 : 13,
	26 : 42,
	27 : 160,
	29 : 102,
	30 : 98,
	31 : 189,
	32 : 7,
	33 : 23,
	34 : 36,
	35 : 64,
	36 : 24,
	37 : 82,
	38 : 61,
	39 : 109,
	40 : 19,
	41 : 85,
	42 : 91,
	43 : 140,
	44 : 46,
	45 : 156,
	46 : 135,
	47 : 193,
	48 : 15,
	49 : 54,
	50 : 62,
	51 : 149,
	52 : 68,
	53 : 122,
	54 : 116,
	55 : 170,
	56 : 75,
	57 : 129,
	58 : 130,
	59 : 202,
	60 : 97,
	61 : 213,
	62 : 177,
	63 : 233,
	64 : 4,
	65 : 31,
	66 : 28,
	67 : 69,
	68 : 29,
	69 : 77,
	70 : 50,
	71 : 108,
	72 : 26,
	73 : 81,
	74 : 88,
	75 : 153,
	76 : 51,
	77 : 121,
	78 : 128,
	79 : 212,
	80 : 34,
	81 : 80,
	82 : 84,
	83 : 118,
	84 : 79,
	85 : 113,
	86 : 119,
	87 : 184,
	89 : 120,
	90 : 151,
	91 : 171,
	92 : 106,
	93 : 185,
	94 : 214,
	95 : 244,
	96 : 16,
	97 : 70,
	98 : 63,
	99 : 117,
	100 : 53,
	101 : 123,
	102 : 150,
	103 : 169,
	105 : 154,
	106 : 141,
	107 : 180,
	108 : 161,
	109 : 172,
	110 : 201,
	111 : 223,
	113 : 107,
	114 : 111,
	115 : 167,
	116 : 103,
	117 : 186,
	118 : 168,
	119 : 220,
	120 : 100,
	121 : 216,
	122 : 194,
	123 : 224,
	124 : 190,
	125 : 245,
	126 : 234,
	127 : 248,
	128 : 8,
	129 : 9,
	130 : 17,
	131 : 73,
	132 : 21,
	133 : 72,
	134 : 47,
	135 : 96,
	136 : 35,
	137 : 60,
	138 : 90,
	139 : 132,
	140 : 59,
	141 : 115,
	142 : 136,
	143 : 176,
	144 : 22,
	145 : 55,
	146 : 87,
	147 : 127,
	148 : 83,
	149 : 124,
	150 : 157,
	151 : 211,
	153 : 148,
	154 : 139,
	155 : 200,
	156 : 112,
	157 : 166,
	158 : 192,
	159 : 240,
	160 : 20,
	162 : 89,
	163 : 134,
	164 : 86,
	165 : 155,
	166 : 144,
	167 : 198,
	168 : 92,
	169 : 143,
	170 : 146,
	171 : 207,
	172 : 142,
	173 : 181,
	174 : 208,
	175 : 230,
	176 : 48,
	177 : 162,
	178 : 145,
	179 : 206,
	180 : 158,
	181 : 173,
	182 : 182,
	183 : 228,
	184 : 137,
	185 : 203,
	186 : 209,
	187 : 241,
	188 : 196,
	189 : 226,
	190 : 231,
	191 : 252,
	192 : 10,
	193 : 37,
	195 : 93,
	196 : 56,
	197 : 101,
	198 : 159,
	199 : 188,
	200 : 57,
	201 : 110,
	202 : 138,
	203 : 191,
	204 : 147,
	205 : 164,
	206 : 199,
	207 : 239,
	208 : 65,
	209 : 105,
	210 : 152,
	211 : 218,
	212 : 125,
	213 : 183,
	214 : 174,
	215 : 243,
	216 : 114,
	217 : 163,
	218 : 179,
	219 : 222,
	220 : 165,
	221 : 219,
	222 : 221,
	223 : 247,
	224 : 76,
	225 : 94,
	226 : 131,
	227 : 175,
	228 : 126,
	229 : 217,
	230 : 205,
	231 : 237,
	232 : 133,
	233 : 195,
	234 : 210,
	235 : 229,
	236 : 204,
	237 : 225,
	238 : 242,
	239 : 251,
	240 : 99,
	241 : 187,
	242 : 197,
	243 : 238,
	244 : 215,
	245 : 246,
	246 : 227,
	247 : 250,
	248 : 178,
	249 : 235,
	250 : 232,
	251 : 254,
	252 : 236,
	253 : 249,
	254 : 253,
	255 : 255,
}
# 4 point bit to id
const debug_secondary_bits_to_id : Dictionary[int,int] = {
	0 : 0,
	1 : 5,
	2 : 6,
	3 : 18,
	4 : 7,
	5 : 35,
	6 : 19,
	7 : 91,
	8 : 8,
	9 : 17,
	10 : 36,
	11 : 90,
	12 : 20,
	13 : 89,
	14 : 92,
	15 : 133
}
#id to atlas coords
const debug_id_to_atlas : Dictionary[int,Array] = {
	0 : [Vector2i(0,0)],
	1 : [Vector2i(1,0)],
	2 : [Vector2i(1,1)],
	3 : [Vector2i(1,2)],
	4 : [Vector2i(1,3)],
	5 : [Vector2i(2,0)],
	6 : [Vector2i(2,1)],
	7 : [Vector2i(2,2)],
	8 : [Vector2i(2,3)],
	9 : [Vector2i(3,0)],
	10 : [Vector2i(3,1)],
	11 : [Vector2i(3,2)],
	12 : [Vector2i(3,3)],
	13 : [Vector2i(3,4)],
	14 : [Vector2i(3,5)],
	15 : [Vector2i(3,6)],
	16 : [Vector2i(3,7)],
	17 : [Vector2i(4,0)],
	18 : [Vector2i(4,1)],
	19 : [Vector2i(4,2)],
	20 : [Vector2i(4,3)],
	21 : [Vector2i(5,0)],
	22 : [Vector2i(5,1)],
	23 : [Vector2i(5,2)],
	24 : [Vector2i(5,3)],
	25 : [Vector2i(5,4)],
	26 : [Vector2i(5,5)],
	27 : [Vector2i(5,6)],
	28 : [Vector2i(5,7)],
	29 : [Vector2i(6,0)],
	30 : [Vector2i(6,1)],
	31 : [Vector2i(7,0)],
	32 : [Vector2i(7,1)],
	33 : [Vector2i(7,2)],
	34 : [Vector2i(7,3)],
	35 : [Vector2i(8,0)],
	36 : [Vector2i(8,1)],
	37 : [Vector2i(9,0)],
	38 : [Vector2i(9,1)],
	39 : [Vector2i(9,2)],
	40 : [Vector2i(9,3)],
	41 : [Vector2i(10,0)],
	42 : [Vector2i(10,1)],
	43 : [Vector2i(10,2)],
	44 : [Vector2i(10,3)],
	45 : [Vector2i(10,4)],
	46 : [Vector2i(10,5)],
	47 : [Vector2i(10,6)],
	48 : [Vector2i(10,7)],
	49 : [Vector2i(11,0)],
	50 : [Vector2i(11,1)],
	51 : [Vector2i(11,2)],
	52 : [Vector2i(11,3)],
	53 : [Vector2i(11,4)],
	54 : [Vector2i(11,5)],
	55 : [Vector2i(11,6)],
	56 : [Vector2i(11,7)],
	57 : [Vector2i(12,0)],
	58 : [Vector2i(12,1)],
	59 : [Vector2i(12,2)],
	60 : [Vector2i(12,3)],
	61 : [Vector2i(12,4)],
	62 : [Vector2i(12,5)],
	63 : [Vector2i(12,6)],
	64 : [Vector2i(12,7)],
	65 : [Vector2i(13,0)],
	66 : [Vector2i(13,1)],
	67 : [Vector2i(13,2)],
	68 : [Vector2i(13,3)],
	69 : [Vector2i(13,4)],
	70 : [Vector2i(13,5)],
	71 : [Vector2i(13,6)],
	72 : [Vector2i(13,7)],
	73 : [Vector2i(14,0)],
	74 : [Vector2i(14,1)],
	75 : [Vector2i(14,2)],
	76 : [Vector2i(14,3)],
	77 : [Vector2i(15,0)],
	78 : [Vector2i(15,1)],
	79 : [Vector2i(15,2)],
	80 : [Vector2i(15,3)],
	81 : [Vector2i(16,0)],
	82 : [Vector2i(16,1)],
	83 : [Vector2i(16,2)],
	84 : [Vector2i(16,3)],
	85 : [Vector2i(17,0)],
	86 : [Vector2i(17,1)],
	87 : [Vector2i(17,2)],
	88 : [Vector2i(17,3)],
	89 : [Vector2i(18,0)],
	90 : [Vector2i(18,1)],
	91 : [Vector2i(18,2)],
	92 : [Vector2i(18,3)],
	93 : [Vector2i(19,0)],
	94 : [Vector2i(19,1)],
	95 : [Vector2i(19,2)],
	96 : [Vector2i(19,3)],
	97 : [Vector2i(19,4)],
	98 : [Vector2i(19,5)],
	99 : [Vector2i(19,6)],
	100 : [Vector2i(19,7)],
	101 : [Vector2i(20,0)],
	102 : [Vector2i(20,1)],
	103 : [Vector2i(20,2)],
	104 : [Vector2i(20,3)],
	105 : [Vector2i(20,4)],
	106 : [Vector2i(20,5)],
	107 : [Vector2i(20,6)],
	108 : [Vector2i(20,7)],
	109 : [Vector2i(21,0)],
	110 : [Vector2i(21,1)],
	111 : [Vector2i(21,2)],
	112 : [Vector2i(21,3)],
	113 : [Vector2i(22,0)],
	114 : [Vector2i(23,0)],
	115 : [Vector2i(23,1)],
	116 : [Vector2i(23,2)],
	117 : [Vector2i(23,3)],
	118 : [Vector2i(24,0)],
	119 : [Vector2i(24,1)],
	120 : [Vector2i(24,2)],
	121 : [Vector2i(24,3)],
	122 : [Vector2i(24,4)],
	123 : [Vector2i(24,5)],
	124 : [Vector2i(24,6)],
	125 : [Vector2i(24,7)],
	126 : [Vector2i(25,0)],
	127 : [Vector2i(25,1)],
	128 : [Vector2i(25,2)],
	129 : [Vector2i(25,3)],
	130 : [Vector2i(26,0)],
	131 : [Vector2i(26,1)],
	132 : [Vector2i(26,2)],
	133 : [Vector2i(26,3)],
	134 : [Vector2i(26,4)],
	135 : [Vector2i(26,5)],
	136 : [Vector2i(26,6)],
	137 : [Vector2i(26,7)],
	138 : [Vector2i(27,0)],
	139 : [Vector2i(27,1)],
	140 : [Vector2i(27,2)],
	141 : [Vector2i(27,3)],
	142 : [Vector2i(27,4)],
	143 : [Vector2i(27,5)],
	144 : [Vector2i(27,6)],
	145 : [Vector2i(27,7)],
	146 : [Vector2i(28,0)],
	147 : [Vector2i(29,0)],
	148 : [Vector2i(29,1)],
	149 : [Vector2i(29,2)],
	150 : [Vector2i(29,3)],
	151 : [Vector2i(30,0)],
	152 : [Vector2i(30,1)],
	153 : [Vector2i(30,2)],
	154 : [Vector2i(30,3)],
	155 : [Vector2i(30,4)],
	156 : [Vector2i(30,5)],
	157 : [Vector2i(30,6)],
	158 : [Vector2i(30,7)],
	159 : [Vector2i(31,0)],
	160 : [Vector2i(31,1)],
	161 : [Vector2i(31,2)],
	162 : [Vector2i(31,3)],
	163 : [Vector2i(32,0)],
	164 : [Vector2i(32,1)],
	165 : [Vector2i(32,2)],
	166 : [Vector2i(32,3)],
	167 : [Vector2i(32,4)],
	168 : [Vector2i(32,5)],
	169 : [Vector2i(32,6)],
	170 : [Vector2i(32,7)],
	171 : [Vector2i(33,0)],
	172 : [Vector2i(33,1)],
	173 : [Vector2i(33,2)],
	174 : [Vector2i(33,3)],
	175 : [Vector2i(34,0)],
	176 : [Vector2i(34,1)],
	177 : [Vector2i(34,2)],
	178 : [Vector2i(34,3)],
	179 : [Vector2i(35,0)],
	180 : [Vector2i(35,1)],
	181 : [Vector2i(35,2)],
	182 : [Vector2i(35,3)],
	183 : [Vector2i(36,0)],
	184 : [Vector2i(36,1)],
	185 : [Vector2i(36,2)],
	186 : [Vector2i(36,3)],
	187 : [Vector2i(37,0)],
	188 : [Vector2i(37,1)],
	189 : [Vector2i(37,2)],
	190 : [Vector2i(37,3)],
	191 : [Vector2i(38,0)],
	192 : [Vector2i(38,1)],
	193 : [Vector2i(38,2)],
	194 : [Vector2i(38,3)],
	195 : [Vector2i(38,4)],
	196 : [Vector2i(38,5)],
	197 : [Vector2i(38,6)],
	198 : [Vector2i(38,7)],
	199 : [Vector2i(39,0)],
	200 : [Vector2i(39,1)],
	201 : [Vector2i(39,2)],
	202 : [Vector2i(39,3)],
	203 : [Vector2i(39,4)],
	204 : [Vector2i(39,5)],
	205 : [Vector2i(39,6)],
	206 : [Vector2i(39,7)],
	207 : [Vector2i(40,0)],
	208 : [Vector2i(40,1)],
	209 : [Vector2i(40,2)],
	210 : [Vector2i(40,3)],
	211 : [Vector2i(41,0)],
	212 : [Vector2i(41,1)],
	213 : [Vector2i(41,2)],
	214 : [Vector2i(41,3)],
	215 : [Vector2i(41,4)],
	216 : [Vector2i(41,5)],
	217 : [Vector2i(41,6)],
	218 : [Vector2i(41,7)],
	219 : [Vector2i(42,0)],
	220 : [Vector2i(42,1)],
	221 : [Vector2i(43,0)],
	222 : [Vector2i(43,1)],
	223 : [Vector2i(43,2)],
	224 : [Vector2i(43,3)],
	225 : [Vector2i(43,4)],
	226 : [Vector2i(43,5)],
	227 : [Vector2i(43,6)],
	228 : [Vector2i(43,7)],
	229 : [Vector2i(44,0)],
	230 : [Vector2i(44,1)],
	231 : [Vector2i(44,2)],
	232 : [Vector2i(44,3)],
	233 : [Vector2i(45,0)],
	234 : [Vector2i(45,1)],
	235 : [Vector2i(45,2)],
	236 : [Vector2i(45,3)],
	237 : [Vector2i(45,4)],
	238 : [Vector2i(45,5)],
	239 : [Vector2i(45,6)],
	240 : [Vector2i(45,7)],
	241 : [Vector2i(46,0)],
	242 : [Vector2i(46,1)],
	243 : [Vector2i(47,0)],
	244 : [Vector2i(47,1)],
	245 : [Vector2i(47,2)],
	246 : [Vector2i(47,3)],
	247 : [Vector2i(48,0)],
	248 : [Vector2i(48,1)],
	249 : [Vector2i(48,2)],
	250 : [Vector2i(48,3)],
	251 : [Vector2i(49,0)],
	252 : [Vector2i(49,1)],
	253 : [Vector2i(49,2)],
	254 : [Vector2i(49,3)],
	255 : [Vector2i(50,0)],
}

#removed unused tile locations
const road_primary_bits_to_id : Dictionary[int,int] = {
	0 : 0,
	1 : 1,
	2 : 5,
	4 : 2,
	5 : 32,
	8 : 6,
	9 : 25,
	10 : 18,
	14 : 74,
	15 : 95,
	16 : 3,
	17 : 30,
	18 : 27,
	20 : 33,
	21 : 78,
	30 : 98,
	32 : 7,
	33 : 23,
	34 : 36,
	36 : 24,
	37 : 82,
	40 : 19,
	41 : 85,
	53 : 122,
	56 : 75,
	60 : 97,
	62 : 177,
	63 : 233,
	64 : 4,
	65 : 31,
	66 : 28,
	68 : 29,
	69 : 77,
	72 : 26,
	73 : 81,
	74 : 88,
	77 : 121,
	80 : 34,
	81 : 80,
	82 : 84,
	83 : 118,
	84 : 79,
	85 : 113,
	86 : 119,
	87 : 184,
	89 : 120,
	93 : 185,
	95 : 244,
	101 : 123,
	117 : 186,
	120 : 100,
	125 : 245,
	126 : 234,
	128 : 8,
	130 : 17,
	131 : 73,
	132 : 21,
	135 : 96,
	136 : 35,
	143 : 176,
	144 : 22,
	146 : 87,
	148 : 83,
	149 : 124,
	159 : 240,
	160 : 20,
	164 : 86,
	170 : 146,
	195 : 93,
	207 : 239,
	212 : 125,
	213 : 183,
	215 : 243,
	224 : 76,
	225 : 94,
	227 : 175,
	231 : 237,
	240 : 99,
	243 : 238,
	245 : 246,
	248 : 178,
	249 : 235,
	252 : 236
}

## converts bits generated in level generation to a list of atlas coordinates[br]
## yes, this is somewhat manual to add to, no, I do not want to fix it
func bits_to_atlas(prim_bits : int, second_bits : int, tile_set : String) -> Array:
	match tile_set:
		"debug":
			var id : int = debug_primary_bits_to_id.get(prim_bits,-1)
			if id == -1:
				id = debug_secondary_bits_to_id.get(second_bits,0)
			return debug_id_to_atlas.get(id)
		"road":
			var id : int = road_primary_bits_to_id.get(prim_bits,-1)
			if id == -1:
				id = debug_secondary_bits_to_id.get(second_bits,0)
			return debug_id_to_atlas.get(id)
	return [Vector2i(0,0)]

## grabs an atlas coordinate for a tileset, sends it forward[br]
## alternate chance is #/100 odds
func grab_atlas(prim_bits : int, second_bits : int, tile_set : String, alternate_chance : int) -> Vector2i:
	var atlas_array : Array = bits_to_atlas(prim_bits,second_bits,tile_set)
	if randi_range(1,100) > alternate_chance or atlas_array.size() <= 1:
		return atlas_array.get(0)
	else:
		return atlas_array.get(randi_range(1,atlas_array.size()-1))

func grab_atlas_id(tile_set) -> int:
	match tile_set:
		"road":
			return 1
		_:
			return 0

## TileSet uids
const tile_set_dict : Dictionary[String,String] = {
	"debug" : "uid://obe0ov82c2j4",
	"road" : "uid://bs6vbjd02p3k8"
}

## just to ensure nothing breaks, please use this :)
func lock_and_load_tileset(tile_set : String) -> TileSet:
	return load(tile_set_dict.get(tile_set,"uid://obe0ov82c2j4"))
